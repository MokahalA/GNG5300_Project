<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Meal Planner</title>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
        <style>
            /* Meal plan specific styles */
            .meal-card {
                height: 100%;
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
                transition: transform 0.2s;
            }

            .meal-card:hover {
                transform: translateY(-5px);
            }

            .meal-type {
                font-weight: bold;
                color: #007bff;
            }

            .meal-item {
                padding: 8px 0;
                border-bottom: 1px solid #eee;
            }

            .meal-item:last-child {
                border-bottom: none;
            }

            .day-header {
                background-color: #007bff;
                color: white;
                padding: 10px;
                border-radius: 4px 4px 0 0;
            }

            .badge {
                padding: 8px 12px;
                font-size: 0.9rem;
            }

            .badge i {
                font-size: 0.8rem;
            }
        </style>
    </head>
    <body>
        <div>
            <h1 class="display-4">Welcome, {{ first_name }}!</h1>
            <br><br>
            <p>Here you can generate a 7-day meal plan according to your profile preferences.</p>
            <button class="btn btn-primary mb-4" type="button" id="generateBtn" onclick="generateMealPlans()">
                <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true" id="btnSpinner"></span>
                <span id="btnText">Generate</span>
            </button>

            <!-- Meal Plans Container -->
            <div id="meal-plans-container" class="mt-4">
                <!-- Meal plans will be dynamically inserted here -->
            </div>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
        <script>
            function parseMealPlan(mealPlanText) {
                // Split the text into days, keeping the "Day X:" headers
                const dayRegex = /(Day \d+):([\s\S]*?)(?=(Day \d+:|$))/g;
                const matches = Array.from(mealPlanText.matchAll(dayRegex));
                const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];

                return matches.map((match, index) => {
                    const dayContent = match[2].trim();
                    const meals = {};

                    // Parse meals for each day
                    dayContent.split('\n').forEach(mealLine => {
                        // Remove any leading dash and split by colon
                        const cleanedLine = mealLine.trim().replace(/^-\s*/, '');
                        const [type, dish] = cleanedLine.split(':').map(str => str.trim());

                        if (type && dish) {
                            meals[type.toLowerCase()] = dish;
                        }
                    });

                    return {
                        day: dayNames[index],
                        meals: {
                            breakfast: meals.breakfast || 'No meal specified',
                            lunch: meals.lunch || 'No meal specified',
                            dinner: meals.dinner || 'No meal specified'
                        }
                    };
                });
            }

            function displayMealPlans(mealPlanText, dietaryPreferences = [], allergies = []) {
                const container = document.getElementById('meal-plans-container');
                const mealPlans = parseMealPlan(mealPlanText);

                // Start HTML with heading
                let html = '<h3 class="mb-4">Your Meal Plan</h3>';
                html += '<br>';

                // Add dietary tags section if there are preferences or allergies
                if (dietaryPreferences.length > 0 || allergies.length > 0) {
                    html += '<div class="mb-4">';

                    // Add dietary preference tags
                    dietaryPreferences.forEach(pref => {
                        html += `
                            <span class="badge bg-success me-2 mb-2">
                                <i class="fas fa-check-circle me-1"></i>${pref}
                            </span>
                        `;
                    });

                    // Add allergy tags
                    allergies.forEach(allergy => {
                        html += `
                            <span class="badge bg-danger me-2 mb-2">
                                <i class="fas fa-ban me-1"></i>${allergy} Free
                            </span>
                        `;
                    });

                    html += '</div>';
                }

                // Add meal cards container
                html += '<div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">';

                // Add meal cards
                mealPlans.forEach(dayPlan => {
                    html += `
                        <div class="col">
                            <div class="card meal-card">
                                <div class="day-header">
                                    <h5 class="mb-0">${dayPlan.day}</h5>
                                </div>
                                <div class="card-body">
                                    <div class="meal-item">
                                        <span class="meal-type">Breakfast</span>
                                        <div class="ms-2">${dayPlan.meals.breakfast}</div>
                                    </div>
                                    <div class="meal-item">
                                        <span class="meal-type">Lunch</span>
                                        <div class="ms-2">${dayPlan.meals.lunch}</div>
                                    </div>
                                    <div class="meal-item">
                                        <span class="meal-type">Dinner</span>
                                        <div class="ms-2">${dayPlan.meals.dinner}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            }

            async function generateMealPlans() {
                const spinner = document.getElementById('btnSpinner');
                const btnText = document.getElementById('btnText');
                const btn = document.getElementById('generateBtn');
                const container = document.getElementById('meal-plans-container');

                // Show spinner and disable button
                spinner.classList.remove('d-none');
                btn.disabled = true;
                btnText.textContent = 'Generating...';

                try {
                    const response = await fetch('getMealPlan/', {
                        method: 'GET',
                        headers: {
                            "Accept": "application/json",
                            "Content-Type": "application/json",
                            "X-CSRFToken": "{{ csrf_token }}",
                            "X-Requested-With": "XMLHttpRequest"
                        }
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Meal plans response:', data);

                    // Display the meal plans with dietary information
                    displayMealPlans(
                        data.response,
                        data.dietary_preferences || [],
                        data.allergies || []
                    );

                } catch (error) {
                    console.error('Error generating meal plans:', error);
                    container.innerHTML = `
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            Failed to generate meal plans. Please try again later.
                        </div>
                    `;
                } finally {
                    // Reset button state
                    spinner.classList.add('d-none');
                    btn.disabled = false;
                    btnText.textContent = 'Generate';
                }
            }
        </script>
    </body>
</html>
